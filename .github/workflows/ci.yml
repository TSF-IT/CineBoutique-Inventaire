name: ci
on: [push, pull_request, workflow_dispatch]

env:
  AppSettings__SeedOnStartup: true

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: public.ecr.aws/docker/library/postgres:16-alpine
        ports:
          - 5432/tcp
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cineboutique
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --name ci-postgres

    env:
      ASPNETCORE_ENVIRONMENT: CI
      DOTNET_ENVIRONMENT: CI
      AppSettings__SeedOnStartup: true
      DOTNET_CLI_TELEMETRY_OPTOUT: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET from global.json
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: |
            Directory.Packages.props
            **/*.csproj

      - name: Export DB env (build the conn string with mapped port)
        run: |
          echo "PGPORT=${{ job.services.postgres.ports['5432'] }}" >> $GITHUB_ENV
          echo "ConnectionStrings__Default=Host=127.0.0.1;Port=${{ job.services.postgres.ports['5432'] }};Database=cineboutique;Username=postgres;Password=postgres" >> $GITHUB_ENV
          echo "TEST_DB_CONN=Host=127.0.0.1;Port=${{ job.services.postgres.ports['5432'] }};Database=cineboutique;Username=postgres;Password=postgres" >> $GITHUB_ENV

      - name: Dotnet info
        run: |
          which dotnet
          dotnet --info
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Restore
        run: dotnet restore --verbosity minimal

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Test (.NET) - TRX + couverture
        run: |
          rm -rf test-results/dotnet
          mkdir -p test-results/dotnet
          dotnet test --no-build -c Release \
            --logger "trx;LogFileName=test.trx" \
            --results-directory "test-results/dotnet" \
            --collect:"XPlat Code Coverage;Format=cobertura"

      - name: ReportGenerator (HTML)
        run: |
          # Installer l'outil et l'ajouter au PATH
          dotnet tool install --global dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

          # Debug : montre les fichiers réellement présents
          find test-results/dotnet -type f -name "coverage.cobertura.xml" -print

          # IMPORTANT : le ';' doit être QUOTÉ pour ne pas être interprété par bash
          reportgenerator \
            -reports:'test-results/dotnet/**/coverage.cobertura.xml' \
            -targetdir:'test-results/dotnet/coverage-report' \
            -reporttypes:'HtmlInline;Cobertura'

      - name: Upload TRX
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-trx
          path: test-results/dotnet/**/*.trx

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: test-results/dotnet/coverage-report/**

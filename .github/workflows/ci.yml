name: ci
on: [push, pull_request, workflow_dispatch]

env:
  AppSettings__SeedOnStartup: true

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      ASPNETCORE_ENVIRONMENT: CI
      DOTNET_ENVIRONMENT: CI
      AppSettings__SeedOnStartup: true
      DOTNET_CLI_TELEMETRY_OPTOUT: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PostgreSQL (no container)
        uses: ankane/setup-postgres@v1
        with:
          postgres-version: 16
          database: cineboutique

      - name: Init CI DB user/password (mirror docker-compose env)
        shell: bash
        run: |
          # user par défaut = 'runner', sans mot de passe (cf. doc de l'action)
          psql -d postgres -c "DO $$ BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname='postgres') THEN
              CREATE ROLE postgres WITH LOGIN SUPERUSER PASSWORD 'postgres';
            ELSE
              ALTER ROLE postgres WITH PASSWORD 'postgres';
            END IF;
          END $$;"
          # DB déjà créée par l'étape précédente (database: cineboutique), on s'assure des droits
          psql -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE cineboutique TO postgres;"

      - name: Wait for PostgreSQL
        shell: bash
        run: |
          for i in {1..30}; do
            if psql -d postgres -c 'select 1' >/dev/null 2>&1; then
              echo "DB ready"; exit 0;
            fi
            sleep 1
          done
          echo "DB not ready in time"; exit 1

      - name: Setup .NET from global.json
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: |
            Directory.Packages.props
            **/*.csproj

      - name: Export DB env (build the conn string with mapped port)
        run: |
          echo "PGPORT=5432" >> $GITHUB_ENV
          echo "ConnectionStrings__Default=Host=127.0.0.1;Port=5432;Database=cineboutique;Username=postgres;Password=postgres" >> $GITHUB_ENV
          echo "TEST_DB_CONN=Host=127.0.0.1;Port=5432;Database=cineboutique;Username=postgres;Password=postgres" >> $GITHUB_ENV

      - name: Dotnet info
        run: |
          which dotnet
          dotnet --info
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Restore
        run: dotnet restore --verbosity minimal

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Test (.NET) - TRX + couverture
        run: |
          rm -rf test-results/dotnet
          mkdir -p test-results/dotnet
          dotnet test --no-build -c Release \
            --logger "trx;LogFileName=test.trx" \
            --results-directory "test-results/dotnet" \
            --collect:"XPlat Code Coverage;Format=cobertura"

      - name: ReportGenerator (HTML)
        run: |
          # Installer l'outil et l'ajouter au PATH
          dotnet tool install --global dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

          # Debug : montre les fichiers réellement présents
          find test-results/dotnet -type f -name "coverage.cobertura.xml" -print

          # IMPORTANT : le ';' doit être QUOTÉ pour ne pas être interprété par bash
          reportgenerator \
            -reports:'test-results/dotnet/**/coverage.cobertura.xml' \
            -targetdir:'test-results/dotnet/coverage-report' \
            -reporttypes:'HtmlInline;Cobertura'

      - name: Upload TRX
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-trx
          path: test-results/dotnet/**/*.trx

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: test-results/dotnet/coverage-report/**

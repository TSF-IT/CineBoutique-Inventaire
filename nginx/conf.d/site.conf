server {
  listen 80;
  listen [::]:80;

  # Health HTTP (pour healthcheck Docker)
  location = /health { return 200 'ok'; add_header Content-Type text/plain; }

  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name _;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/privkey.pem;

  gzip on;
  gzip_types text/css application/javascript application/json image/svg+xml application/manifest+json;
  gzip_min_length 1024;

  # --- Racine de la SPA ---
  root  /usr/share/nginx/html;
  index index.html;

  # -----------------------------
  # PWA : fichiers critiques = jamais en cache
  # -----------------------------
  location = /sw.js {
    add_header Cache-Control "no-store" always;
    try_files $uri =404;
  }

  location = /manifest.webmanifest {
    add_header Cache-Control "no-store" always;
    add_header Content-Type "application/manifest+json" always;
    try_files $uri =404;
  }

  # Si quelqu'un appelle /index.html directement, on force aussi no-store
  location = /index.html {
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    try_files $uri =404;
  }

  location ~ ^/apple-touch-icon(?:-[0-9]+)?\.png$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    try_files $uri =404;
  }

  location ~ ^/icons/(?:pwa|maskable).*\.png$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    try_files $uri =404;
  }

  # -----------------------------
  # Assets fingerprintés : cache long
  # -----------------------------
  location ~* \.(?:js|css|woff2|png|jpg|jpeg|gif|svg|ico)$ {
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    try_files $uri =404;
  }

  # -----------------------------
  # API : un seul bloc /api/ (pas d'include)
  # -----------------------------
  location ^~ /api/ {
    proxy_http_version 1.1;
    proxy_set_header   Connection "";
    add_header Cache-Control "no-store" always;
    proxy_pass http://api:8080$request_uri;  # blue par défaut
  }

  # -----------------------------
  # Swagger proxifié vers l'API
  # -----------------------------
  location = /swagger { return 302 /swagger/index.html; }
  location ^~ /swagger/ {
    proxy_http_version 1.1;
    proxy_set_header   Connection "";
    proxy_pass http://api:8080/swagger/;
  }

  # -----------------------------
  # SPA : fallback avec no-store sur le shell
  # -----------------------------
  location / {
    # IMPORTANT : ne pas mettre $uri/ pour éviter que Nginx serve le répertoire /
    # avec la directive 'index' en court-circuitant nos en-têtes.
    try_files $uri @spa;
  }

  location @spa {
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    # Servez directement le fichier depuis ce bloc (pas de rewrite vers =/index.html)
    # pour garantir l'application des en-têtes ci-dessus.
    try_files /index.html =404;
  }

  # Health HTTPS
  location = /health { return 200 'ok'; add_header Content-Type text/plain; }
}
